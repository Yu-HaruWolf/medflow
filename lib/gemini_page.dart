import 'package:firebase_vertexai/firebase_vertexai.dart';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

import 'app_state.dart';
import 'package:http/http.dart' as http;
import 'dart:convert';

class GeminiPage extends StatefulWidget {
  @override
  State<GeminiPage> createState() => _GeminiPageState();
}

class _GeminiPageState extends State<GeminiPage> {
  String responseText = "Sample";

  @override
  Widget build(BuildContext context) {
    final appState = Provider.of<ApplicationState>(context);
    return SingleChildScrollView(
      child: Container(
        child: Column(
          children: [
            Text(responseText),
            ElevatedButton(
              onPressed: () async {
                final response = await fetchWeatherData(
                  "Please investigate NANDA-I. What types of NANDA-I exist, and please tell me all the evaluation criteria for each.",
                );
                if (response != null) {
                  setState(() {
                    responseText =
                        response['response']; // Cloud Functionからのレスポンスを更新
                  });
                } else {
                  setState(() {
                    responseText = "Failed to load data";
                  });
                }

                // 過去の会話履歴
                final history1 = [
                  Content.text(
                    'NANDA-Iについて調べてください。どのようなNANDA-Iがあり、それぞれの評価項目をすべて教えてください。',
                  ),
                  Content.model([TextPart(responseText)]),
                ];

                Stream<GenerateContentResponse> responseStream1 = await appState
                    .model
                    .startChat(history: history1)
                    .sendMessageStream(
                      Content.text("""会話履歴をもとに、最適で一番重要視するNANDA-Iを1つ決めてください。
【10日目】
S
「リハビリで歩く距離が伸びてきました。痛みは日中はほとんど気になりません。家で一人
でもやっていけそうな気がしてきましたが、雨の日の通勤が心配です。」
O
• 創部の状態：治癒良好、発赤・腫脹なし
• 褥瘡の有無：なし
• 体温：36.4℃
• 血圧：120/76mmHg
• 脈拍：74回/分
• 松葉杖の使用状態：院内の長距離も自立
• 入院中の日常生活動作：自立
• 退院後介助者：なし
• 仕事の状況：復職希望、通勤は電車・徒歩
• 可動域：ほぼ正常
• 食事の状況：全量摂取、間食なし
• 血糖値（朝食前）：120mg/dL
A
ADL 自立。松葉杖歩行も安定。退院後の生活に対する自信がついてきている。雨天時の移
動方法に課題あり。
P
• 雨天時の通勤対策としてカッパの使用を提案し、使い方を指導
• 必要に応じて福祉用具の導入を再検討
• 退院後もリハビリを継続できるよう理学療法士と連携
• 糖尿病管理のため食事指導を継続
入院時看護データベース
科: 整形外科
情報提供者: 本人
記載者: ○○
氏名: 山田 太郎
年齢: 58歳
性別: 男
入院日: 2025年5月1日
現住所: 東京都世田谷区
連絡先: 長男 山田一郎（TEL: 090-xxxx-xxxx）
搬送方法: ストレッチャー
診断名: 右下肢骨折
入院までの経過: 自宅で転倒し右下肢を骨折。救急搬送され手術目的で入院。
主訴: 右下肢の痛み、歩行困難
入院目的: 骨折部の手術およびリハビリテーション
現在の病気について医師からの説明とそのとらえ方: 骨折部の手術とリハビリが必要で、回復には数ヶ月かかると説明あり。本人は「一人暮らしなので早く自立したい」と希望している。
本人: 退院後も自宅で一人で生活したいと強く希望。
家族（続柄）: 長男（別居）、時々様子を見に来る。
入院時看護データベース2
既往歴: 糖尿病（インスリン自己注射）、高血圧
入院までの服薬履歴: 糖尿病薬、降圧薬
健康管理の方法: 定期的な通院、自己血糖測定
たばこ: 無
酒: 1日1合程度
食事摂取状況:
日常の食事形態：常食
嗜好：魚、野菜中心
食欲：普通
摂取方法：自力
水分摂取：1日1L程度
体重: 65kg（入院時）
身長: 170cm
BMI: 22.5
血液データ: 血糖値高値、肝機能正常、貧血なし
その他の関連情報: 退院後も一人暮らし予定。通勤は電車と徒歩（駅から会社まで15分）。
入院時看護データベース3
排泄パターン: 1日1回、便秘傾向なし
創部の状態: 手術創あり、発赤・腫脹軽度、滲出液なし
床ずれの有無: なし
バイタル:
体温：36.6℃
脈拍：72回/分
血圧：130/80mmHg
松葉杖の使用状態: 理学療法士指導のもと、歩行訓練中。屋内は自立、屋外は介助必要。
入院中の日常生活動作:
食事：自立
洗面：自立
更衣：自立
入浴：介助必要
排泄：自立
退院後、介助してくれる人: 基本的にいないが、長男が週1回程度訪問予定
仕事の状況: 会社員、デスクワーク。退院後は復職予定。
可動域の有無: 右下肢に制限あり
食事の状況: 糖尿病食指導中
入院時看護データベース 4
自動車椅子の操作／歩行方法（必要時車椅子入る）
ベッド上動作：a. 自力で自由に動ける
起き上がり：a. 自力でできる
座位保持：a. 自力でできる
車椅子移乗：b. 介助を要する
歩行：b. 杖・歩行器使用が必要
歩行距離：自宅内は可、屋外は困難
介助方法：松葉杖指導中、理学療法士とリハビリ実施
転倒・転落の危険性
b. 自力では移動が困難なため注意が必要
呼吸
息切れ：なし
咳嗽：なし
喘鳴：なし
主な持病
糖尿病、高血圧
服薬状況：自己管理
バイタル：R: 18、P: 72
胸の聴診：異常なし
X線：右下肢骨折所見
循環器系の治療有無
有（高血圧治療中）
ECG：異常なし
睡眠状況
時間帯：23時～6時
服薬：睡眠薬なし
眠れないときの対処法：読書
睡眠についての様子：夜間痛みで中途覚醒あり
入院時看護データベース 5
言語レベル・コミュニケーション
意思疎通：良好
聴覚：右正常、左正常
視覚：右正常、左正常
知覚：異常なし
筋力（MMT）
上肢：正常
下肢：右やや低下（骨折部）
自分のことをどう思っていますか
早く回復し自立したい。退院後も一人で生活したい。
悩みや不安に対し、手助けできることはありますか
リハビリや生活動作の指導を希望
身体の症状の悩み
夜間の痛み、歩行時の不安
入院時看護データベース 6
家族構成
本人一人暮らし
長男（別居、週1回訪問）
経済状況
年金と給与で生活
宗教
特になし
社会的グループ所属
なし
最近の生活の変化
骨折による入院で仕事を休職中
ストレス対処法
音楽鑑賞、読書
今後の生活計画
退院後は自宅復帰し、職場復帰を目指す
入院時看護データベース 7
生活歴・価値観
仕事：会社員（デスクワーク）
趣味：読書、音楽鑑賞
生活目標：健康を維持し自立した生活を送ること
退院後の希望：自宅で一人暮らしを継続し、復職したい
その他：糖尿病管理を継続しつつ、生活リズムを整えたい"""),
                    );
                String intermediateResponse = "";
                await for (final response in responseStream1) {
                  final responseResultText = response.text;
                  if (responseResultText != null) {
                    setState(() {
                      intermediateResponse += responseResultText;
                    });
                  }
                }
                final history2 = [
                  Content.text('最適なNANDA-Iを１つ決めてください。'),
                  Content.model([TextPart(intermediateResponse)]),
                ];

                Stream<GenerateContentResponse> responseStream = await appState
                    .model
                    .startChat(history: history2)
                    .sendMessageStream(
                      Content.text("""重要視するNANDA-Iの項目非効果的健康自己管理リスク状態となりました。

１．googel検索でこのNANDA-Iの項目における看護計画を作成し、
２．SOAPや入院時データベースから患者の個別性を加えてください。
作成する看護計画は以下の内容として、json形式で出力してください。

・O-P (観察項目)
・T-P 援助
・E-P（指導）



【1日目】
S
「膝の痛みは昼間は我慢できる程度ですが、夜になるとズキズキして眠りにくいです。松葉
杖はまだ慣れません。食事は病院のものなら問題なく食べられます。」
O
A
• 創部の状態：発赤・腫脹なし、滲出液なし
• 褥瘡の有無：なし
• 体温：36.6℃
• 血圧：128/78mmHg
• 脈拍：78回/分
• 松葉杖の使用状態：不安定、歩行時にふらつきあり
• 入院中の日常生活動作：ベッドからの起き上がり介助必要、トイレ・食事は自立
• 退院後介助者：一人暮らし予定
• 仕事の状況：復職希望、通勤は電車・徒歩
• 可動域：膝屈伸制限あり
• 食事の状況：全量摂取、間食なし
• 血糖値（朝食前）：128mg/dL
夜間の痛みが強く、睡眠に影響あり。松葉杖歩行は不安定で転倒リスクあり。ADLは一部
介助必要。糖尿病管理は現状維持。
P
• 痛み止めの服用時間を調整し、夜間の痛み緩和を図る
• 理学療法士と連携し、松葉杖歩行指導を強化
• ADLの自立に向けて、布団からの起き上がり練習を開始
• 栄養士と連携し、糖尿病食の指導を継続
【2日目】
S
「昨日より少し痛みが和らいだ気がします。夜も少し眠れました。松葉杖はまだ不安です。」
O
• 創部の状態：発赤なし、乾燥良好
• 褥瘡の有無：なし
• 体温：36.7℃
• 血圧：130/80mmHg
• 脈拍：80回/分
• 松葉杖の使用状態：歩行時に介助必要
• 入院中の日常生活動作：ベッドからの起き上がり介助必要
• 退院後介助者：一人暮らし予定
• 仕事の状況：復職希望
• 可動域：膝屈伸制限あり
• 食事の状況：全量摂取
• 血糖値（朝食前）：126mg/dL
A
痛みはやや軽減傾向。松葉杖歩行は引き続き不安定。ADLは変化なし。
P
• 松葉杖の使い方を再指導
• 痛みの変化を継続観察
• ADL練習を継続
【3日目】
S
「夜の痛みはまだありますが、昨日よりは眠れました。松葉杖で短い距離なら少し歩けるよ
うになりました。」
O
A
• 創部の状態：発赤・腫脹なし
• 褥瘡の有無：なし
• 体温：36.5℃
• 血圧：126/78mmHg
• 脈拍：77回/分
• 松葉杖の使用状態：短距離は自立、長距離は介助必要
• 入院中の日常生活動作：ベッドからの起き上がり練習中
• 退院後介助者：一人暮らし予定
• 仕事の状況：復職希望
• 可動域：膝屈伸制限やや改善
• 食事の状況：全量摂取
• 血糖値（朝食前）：125mg/dL
短距離歩行は自立可能に。夜間の痛みは継続。ADLに少し進展あり。
P
• 長距離歩行の練習を追加
• 夜間の痛み対策を再検討
• ADL自立に向けた練習継続
【4日目】
S
「松葉杖で廊下まで歩けました。夜の痛みは薬を飲む時間を変えてもらってから少し楽で
す。」
O
A
• 創部の状態：乾燥良好、発赤なし
• 褥瘡の有無：なし
• 体温：36.6℃
• 血圧：125/76mmHg
• 脈拍：76回/分
• 松葉杖の使用状態：短距離自立、長距離はやや不安定
• 入院中の日常生活動作：トイレ・食事は自立、起き上がり練習中
• 退院後介助者：一人暮らし予定
• 仕事の状況：復職希望
• 可動域：膝屈伸やや改善
• 食事の状況：全量摂取
• 血糖値（朝食前）：124mg/dL
夜間の痛みは軽減傾向。歩行距離が伸びている。ADLも改善。
P
• 長距離歩行の安定化を目指す
• 夜間の痛み観察継続
• ADL自立に向けたサポート継続
【5日目】
S
「松葉杖には少し慣れてきましたが、長い距離を歩くのはまだ不安です。夜の痛みは薬の時
間を変えてから少し楽になりました。家で一人で生活できるか心配です。」
O
• 創部の状態：乾燥良好、発赤・腫脹なし
• 褥瘡の有無：なし
• 体温：36.5℃
• 血圧：124/80mmHg
• 脈拍：76回/分
• 松葉杖の使用状態：短距離は自立、長距離は不安定
• 入院中の日常生活動作：トイレ・食事は自立、ベッドからの起き上がりは練習中
• 退院後介助者：一人暮らし予定
• 仕事の状況：復職希望、通勤は電車・徒歩
• 可動域：膝屈伸やや制限
• 食事の状況：全量摂取、間食時々あり
• 血糖値（朝食前）：124mg/dL
A
松葉杖歩行は短距離自立可能だが、長距離は不安。夜間の痛みは改善傾向。ADLの自立に
向けて課題あり。退院後の生活に不安が強い。
P
• 理学療法士と協力し、駅までの歩行練習を追加
• 布団からの起き上がりが困難な場合、福祉用具の導入を検討
• 退院後の生活動線を確認し、必要なサポートを提案
• 食事指導を継続し、間食の工夫についても助言
【6日目】
S
「歩くのは少しずつ慣れてきました。夜の痛みも薬でコントロールできています。布団から
の起き上がりがまだ難しいです。」
O
A
• 創部の状態：治癒良好、発赤なし
• 褥瘡の有無：なし
• 体温：36.4℃
• 血圧：123/78mmHg
• 脈拍：75回/分
• 松葉杖の使用状態：院内の中距離も自立
• 入院中の日常生活動作：起き上がりは介助時々必要
• 退院後介助者：一人暮らし予定
• 仕事の状況：復職希望
• 可動域：膝屈伸ほぼ正常
• 食事の状況：全量摂取
• 血糖値（朝食前）：123mg/dL
歩行・ADLともに徐々に自立傾向。布団からの起き上がりに課題あり。
P
• 布団からの起き上がり動作の反復練習
• 必要時、福祉用具の導入を検討
• 痛みと血糖値の観察継続
【7日目】
S
「松葉杖で病棟内を歩けるようになりました。夜の痛みはほとんど気になりません。家での
生活が少しイメージできてきました。」
O
A
• 創部の状態：治癒良好
• 褥瘡の有無：なし
• 体温：36.5℃
• 血圧：122/76mmHg
• 脈拍：74回/分
• 松葉杖の使用状態：病棟内長距離も自立
• 入院中の日常生活動作：ほぼ自立、布団からの起き上がり練習中
• 退院後介助者：一人暮らし予定
• 仕事の状況：復職希望
• 可動域：正常範囲
• 食事の状況：全量摂取
• 血糖値（朝食前）：122mg/dL
ADL・歩行ともに自立。退院後の生活に対する自信が少し出てきた。
P
• 退院後の生活動線確認
• 雨天時の通勤対策（カッパ等）を検討
• 食事・血糖管理の継続指導
【8日目】
S
「家での生活に不安はありますが、練習のおかげで自信がついてきました。雨の日の通勤が
心配です。」
O
• 創部の状態：治癒良好、発赤・腫脹なし
• 褥瘡の有無：なし
• 体温：36.4℃
• 血圧：121/75mmHg
• 脈拍：73回/分
• 松葉杖の使用状態：自立
• 入院中の日常生活動作：自立
• 退院後介助者：なし
• 仕事の状況：復職希望
• 可動域：正常
• 食事の状況：全量摂取
• 血糖値（朝食前）：121mg/dL
A
ADL・歩行ともに自立。雨天時の移動に不安あり。
P
• 雨天時の通勤対策としてカッパの使用指導
• 必要時、福祉用具の導入再検討
• 退院後もリハビリ継続できるよう調整
【9日目】
S
「ほとんどのことが一人でできるようになりました。雨の日の通勤だけが心配です。」
O
A
• 創部の状態：治癒良好
• 褥瘡の有無：なし
• 体温：36.4℃
• 血圧：120/76mmHg
• 脈拍：74回/分
• 松葉杖の使用状態：自立
• 入院中の日常生活動作：自立
• 退院後介助者：なし
• 仕事の状況：復職希望
• 可動域：正常
• 食事の状況：全量摂取
• 血糖値（朝食前）：120mg/dL
ADL・歩行ともに自立。退院に向けて最終調整。雨天時の移動方法に課題。
P
• カッパの使用方法を再指導
• 退院後のサポート体制最終確認
• 食事・血糖管理の継続指導
【10日目】
S
「リハビリで歩く距離が伸びてきました。痛みは日中はほとんど気になりません。家で一人
でもやっていけそうな気がしてきましたが、雨の日の通勤が心配です。」
O
• 創部の状態：治癒良好、発赤・腫脹なし
• 褥瘡の有無：なし
• 体温：36.4℃
• 血圧：120/76mmHg
• 脈拍：74回/分
• 松葉杖の使用状態：院内の長距離も自立
• 入院中の日常生活動作：自立
• 退院後介助者：なし
• 仕事の状況：復職希望、通勤は電車・徒歩
• 可動域：ほぼ正常
• 食事の状況：全量摂取、間食なし
• 血糖値（朝食前）：120mg/dL
A
ADL 自立。松葉杖歩行も安定。退院後の生活に対する自信がついてきている。雨天時の移
動方法に課題あり。
P
• 雨天時の通勤対策としてカッパの使用を提案し、使い方を指導
• 必要に応じて福祉用具の導入を再検討
• 退院後もリハビリを継続できるよう理学療法士と連携
• 糖尿病管理のため食事指導を継続
入院時看護データベース
科: 整形外科
情報提供者: 本人
記載者: ○○
氏名: 山田 太郎
年齢: 58歳
性別: 男
入院日: 2025年5月1日
現住所: 東京都世田谷区
連絡先: 長男 山田一郎（TEL: 090-xxxx-xxxx）
搬送方法: ストレッチャー
診断名: 右下肢骨折
入院までの経過: 自宅で転倒し右下肢を骨折。救急搬送され手術目的で入院。
主訴: 右下肢の痛み、歩行困難
入院目的: 骨折部の手術およびリハビリテーション
現在の病気について医師からの説明とそのとらえ方: 骨折部の手術とリハビリが必要で、回復には数ヶ月かかると説明あり。本人は「一人暮らしなので早く自立したい」と希望している。
本人: 退院後も自宅で一人で生活したいと強く希望。
家族（続柄）: 長男（別居）、時々様子を見に来る。
入院時看護データベース2
既往歴: 糖尿病（インスリン自己注射）、高血圧
入院までの服薬履歴: 糖尿病薬、降圧薬
健康管理の方法: 定期的な通院、自己血糖測定
たばこ: 無
酒: 1日1合程度
食事摂取状況:
日常の食事形態：常食
嗜好：魚、野菜中心
食欲：普通
摂取方法：自力
水分摂取：1日1L程度
体重: 65kg（入院時）
身長: 170cm
BMI: 22.5
血液データ: 血糖値高値、肝機能正常、貧血なし
その他の関連情報: 退院後も一人暮らし予定。通勤は電車と徒歩（駅から会社まで15分）。
入院時看護データベース3
排泄パターン: 1日1回、便秘傾向なし
創部の状態: 手術創あり、発赤・腫脹軽度、滲出液なし
床ずれの有無: なし
バイタル:
体温：36.6℃
脈拍：72回/分
血圧：130/80mmHg
松葉杖の使用状態: 理学療法士指導のもと、歩行訓練中。屋内は自立、屋外は介助必要。
入院中の日常生活動作:
食事：自立
洗面：自立
更衣：自立
入浴：介助必要
排泄：自立
退院後、介助してくれる人: 基本的にいないが、長男が週1回程度訪問予定
仕事の状況: 会社員、デスクワーク。退院後は復職予定。
可動域の有無: 右下肢に制限あり
食事の状況: 糖尿病食指導中
入院時看護データベース 4
自動車椅子の操作／歩行方法（必要時車椅子入る）
ベッド上動作：a. 自力で自由に動ける
起き上がり：a. 自力でできる
座位保持：a. 自力でできる
車椅子移乗：b. 介助を要する
歩行：b. 杖・歩行器使用が必要
歩行距離：自宅内は可、屋外は困難
介助方法：松葉杖指導中、理学療法士とリハビリ実施
転倒・転落の危険性
b. 自力では移動が困難なため注意が必要
呼吸
息切れ：なし
咳嗽：なし
喘鳴：なし
主な持病
糖尿病、高血圧
服薬状況：自己管理
バイタル：R: 18、P: 72
胸の聴診：異常なし
X線：右下肢骨折所見
循環器系の治療有無
有（高血圧治療中）
ECG：異常なし
睡眠状況
時間帯：23時～6時
服薬：睡眠薬なし
眠れないときの対処法：読書
睡眠についての様子：夜間痛みで中途覚醒あり
入院時看護データベース 5
言語レベル・コミュニケーション
意思疎通：良好
聴覚：右正常、左正常
視覚：右正常、左正常
知覚：異常なし
筋力（MMT）
上肢：正常
下肢：右やや低下（骨折部）
自分のことをどう思っていますか
早く回復し自立したい。退院後も一人で生活したい。
悩みや不安に対し、手助けできることはありますか
リハビリや生活動作の指導を希望
身体の症状の悩み
夜間の痛み、歩行時の不安
入院時看護データベース 6
家族構成
本人一人暮らし
長男（別居、週1回訪問）
経済状況
年金と給与で生活
宗教
特になし
社会的グループ所属
なし
最近の生活の変化
骨折による入院で仕事を休職中
ストレス対処法
音楽鑑賞、読書
今後の生活計画
退院後は自宅復帰し、職場復帰を目指す
入院時看護データベース 7
生活歴・価値観
仕事：会社員（デスクワーク）
趣味：読書、音楽鑑賞
生活目標：健康を維持し自立した生活を送ること
退院後の希望：自宅で一人暮らしを継続し、復職したい
その他：糖尿病管理を継続しつつ、生活リズムを整えたい
"""),
                    );
                await for (final response in responseStream) {
                  final responseResultText = response.text;
                  if (responseResultText != null) {
                    setState(() {
                      responseText += responseResultText;
                    });
                  }
                }
              },
              child: Text("看護計画を作成する"),
            ),
          ],
        ),
      ),
    );
  }

  // GETリクエストを送信する関数
  Future<Map<String, dynamic>?> fetchWeatherData(String prompt) async {
    final Uri url = Uri.parse(
      'https://asia-northeast1-solution-challenge-458913.cloudfunctions.net/python-http-function',
    ).replace(queryParameters: {'prompt': prompt});

    try {
      final response = await http.get(url);
      print(response.statusCode);
      if (response.statusCode == 200) {
        // レスポンスが正常ならJSONデータを解析して返す
        return json.decode(response.body);
      } else {
        print('Failed to load data');
        return null;
      }
    } catch (e) {
      print('Error: $e');
      return null;
    }
  }
}
